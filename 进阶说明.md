

# 进阶说明

本文档用于详细介绍桔梦。

适用于v22.0

文档施工ing...

本说明中可能会看到(...*)的内容，这意味着该功能需要相关的内容。


## 权限系统

> 未编写

## 词库系统

> 未编写

### 词库逻辑

> 未编写



### 特殊消息(收)

收到的特殊消息大多由go-cqhttp的通知事件产生。这些消息并不是由来自聊天的正常消息所产生的。

| 消息内容      | 含义                                                                                                            |
| ------------- | --------------------------------------------------------------------------------------------------------------- |
| [HH:MM]       | 表示当前时间。由Jiemeng本体产生，每30s检查一次当前时间，若与上次检查结果不同则会发送该消息，例如[07:05],[23:59] |
| CQ code       | 详情参考go-cqhttp的CQ码部分。例如[CQ:image,file=...]                                                            |
| [notice_type] | 当收到go-cqhttp的通知上报时，会收到该消息。例如[group_recall]                                                   |

- [notice_type]
  - notice_type的值取决于 go-cqhttp 的通知的 *notice_type* 字段。详情请参考[这里](https://docs.go-cqhttp.org/event/#%E9%80%9A%E7%9F%A5%E4%B8%8A%E6%8A%A5-1)。
  - 特别地，当这个值为notify时，notice_type将会取 *sub_type* 字段的值。
  - 特别地，当消息为戳一戳([poke])时，Jiemeng 会做进一步处理。目标为bot的戳一戳消息内容为[poke]，其他的则为[poke_others]。

### 发送消息

发送的消息并不是直接依照词库内的文本原封不动地输出，而是先进行一步预处理。
但当消息的权限等级小于0(目前仅在输出程序运行结果时会将消息权限设为负数)时会跳过预处理。

#### 预处理


下面给出预处理的替换规则。

| 内容           | 替换内容                                    |
| -------------- | ------------------------------------------- |
| [\n]           | 换行符                                      |
| [adb+e]        | r点表达式的运算结果，详见【r点表达式】      |
| [name]         | 对方群名片/昵称                             |
| [user_id]      | 对方qq号                                    |
| [group_id]     | 当前群聊群号                                |
| [year]         | 年份                                        |
| [month]        | 月份                                        |
| [yday]         | 今年第x天(1-366)                            |
| [mday]         | 本月第x天(1-31)                             |
| [wday]         | 本周第x天(0-6)                              |
| [hour]         | 小时                                        |
| [min]          | 分钟                                        |
| [sec]          | 秒钟                                        |
| [CQ:at,qq=...] | @该qq号，写[CQ:at,qq=[user_id]]可实现at对方 |
| [CQ:...]       | 更多CQ码功能请参考go-cqhttp                 |
| [Repeat]       | 替换为当前消息                              |

以上内容可以与其他内容混杂于同一条消息中。


#### r点表达式

一个合法的r点表达式为一个仅有数字与【+-*^d()】这些运算的表达式。
##### ()
括号内内容优先计算。
##### d
- 可作单目运算符，也可作双目运算符。
- 表达式 $ndm$ 值等于投掷n个m面骰子(1~m)的结果。
- 注：当n>2^23时，$ndm$将恒为0.
##### +-*^
分别为 加 减 乘 乘方
##### 优先级

表达式中的各项运算满足以下优先级顺序。

【()】>【d】>【^】>【*】>【+ or -】

##### 注意事项

参与计算的数字仅允许为正整数，请避免任何非结果步骤中出现负数。

## 命令

> 待重新编写




## 插件

通过`plugin`指令调用，读取当前消息，然后将插件程序的标准输出作为消息内容输出。

### 预置插件card.exe

用于抽取json牌堆。
- 指令格式：【...\#牌堆名\~调用次数(\~key)】

在不指定key值时，将会抽取card.exe目录下的【牌堆名.json】文件中key值为牌堆名的内容。

(施工ing...)


---
